#+TITLE: Dape: Gu√≠a para Noobs
#+AUTHOR: Documentaci√≥n generada
#+DATE: 2025-12-03

#+begin_quote
‚ö†Ô∏è *NOTA IMPORTANTE*: Esta gu√≠a es el resultado de debuggear dape hasta conseguir que funcionara.
La instalaci√≥n y configuraci√≥n est√° *completamente automatizada* para que no tengas que sufrir lo mismo.
Solo copia la config y funciona. üéØ
#+end_quote

* ¬øQu√© es Dape?

*Dape* (Debug Adapter Protocol for Emacs) es un cliente de depuraci√≥n para Emacs que implementa el *Debug Adapter Protocol (DAP)*.

** ¬øQu√© es DAP?

El *Debug Adapter Protocol* es un protocolo est√°ndar creado por Microsoft para la depuraci√≥n de c√≥digo. Es como LSP (Language Server Protocol) pero para debugging en lugar de edici√≥n de c√≥digo.

*Ventaja principal*: Un √∫nico protocolo para depurar cualquier lenguaje. No necesitas aprender diferentes debuggers para cada lenguaje.

* Dape vs dap-mode

| Caracter√≠stica              | dape                          | dap-mode                      |
|-----------------------------+-------------------------------+-------------------------------|
| Mantenimiento               | Activo (2024)                 | Menos activo                  |
| Instalaci√≥n de adaptadores  | Manual                        | Semi-autom√°tica               |
| Complejidad                 | M√°s simple, minimalista       | M√°s features, m√°s complejo    |
| UI                          | Minimalista, REPL-based       | UI m√°s rica (buffers, panels) |
| Dependencias                | Pocas                         | Muchas (lsp-mode, etc)        |
| Rendimiento                 | M√°s r√°pido                    | M√°s pesado                    |
| Filosof√≠a                   | Unix-like: simple y expl√≠cito | Feature-rich                  |

** ¬øCu√°ndo usar dape?

- Prefieres configuraci√≥n expl√≠cita y simple
- Quieres menos dependencias
- Te gusta la filosof√≠a minimalista
- Eres nuevo en debugging con Emacs (menos overwhelming)

** ¬øCu√°ndo usar dap-mode?

- Necesitas UI rica con muchos paneles
- Quieres instalaci√≥n m√°s autom√°tica
- Ya usas lsp-mode y su ecosistema
- Necesitas features avanzadas espec√≠ficas

* El Rollo de los Adaptadores

** ¬øQu√© es un Debug Adapter?

Un *debug adapter* es un programa que act√∫a como intermediario entre:

#+begin_src
  Emacs (dape) <--DAP--> Debug Adapter <--protocolo espec√≠fico--> Debugger Real
#+end_src

** ¬øPor qu√© existen?

Cada lenguaje tiene su propio debugger:
- PHP ‚Üí Xdebug
- JavaScript ‚Üí Chrome DevTools, Node debugger
- Python ‚Üí debugpy
- Go ‚Üí delve

El Debug Adapter *traduce* entre el protocolo DAP (est√°ndar) y el protocolo espec√≠fico del debugger.

** Ejemplo con PHP/Xdebug

#+begin_src
  Emacs + dape <--DAP--> vscode-php-debug <--DBGP--> Xdebug <--> PHP Runtime
#+end_src

1. *Xdebug* se ejecuta dentro de PHP y usa protocolo DBGP
2. *vscode-php-debug* traduce DBGP ‚Üî DAP
3. *dape* habla DAP con el adaptador
4. *Tu* interact√∫as con dape en Emacs

** ¬øPor qu√© no directamente Emacs ‚Üí Xdebug?

Porque cada debugger tiene su propio protocolo:
- Xdebug usa DBGP
- GDB usa MI protocol
- LLDB usa otro protocolo

Con DAP, solo necesitas *un cliente* (dape) que hable *un protocolo* (DAP).

* Instalaci√≥n de Dape

** 1. Instalar dape en Doom Emacs

En =~/.doom.d/packages.el=:

#+begin_src elisp
(package! dape)
#+end_src

Luego: =doom sync=

** 2. Configuraci√≥n b√°sica

En =~/.doom.d/config.el=:

#+begin_src elisp
(use-package! dape
  :config
  ;; Aqu√≠ van tus configuraciones de adaptadores
  )
#+end_src

* Instalaci√≥n de Adaptadores

** Proceso General

1. *Descargar* el adaptador (usualmente archivo =.vsix= o binario)
2. *Descomprimir* en directorio de adaptadores
3. *Configurar* dape para encontrarlo

** Directorio recomendado

#+begin_src bash
mkdir -p ~/.config/doom/debug-adapters
#+end_src

** Ejemplo: PHP/Xdebug (üéØ INSTALACI√ìN AUTOM√ÅTICA)

*** Paso 1: A√±adir funci√≥n de instalaci√≥n autom√°tica

En =~/.config/doom/config.el=:

#+begin_src elisp
;; Funci√≥n para instalar vscode-php-debug autom√°ticamente
(defun dape-ensure-php-debug-adapter ()
  "Instala vscode-php-debug adapter si no existe."
  (let* ((adapter-dir (expand-file-name "~/.config/doom/debug-adapters/php-debug"))
         (adapter-file (expand-file-name "extension/out/phpDebug.js" adapter-dir))
         (download-url "https://github.com/xdebug/vscode-php-debug/releases/download/v1.35.0/php-debug-1.35.0.vsix")
         (temp-file (make-temp-file "php-debug-" nil ".vsix")))

    (unless (file-exists-p adapter-file)
      (message "üì¶ Instalando vscode-php-debug adapter...")
      (make-directory (expand-file-name "~/.config/doom/debug-adapters") t)
      (url-copy-file download-url temp-file t)
      (message "‚úì Descargado adaptador")
      (call-process "unzip" nil nil nil "-q" temp-file "-d" adapter-dir)
      (delete-file temp-file)
      (message "‚úì Adaptador instalado en %s" adapter-dir)
      (if (file-exists-p adapter-file)
          (message "‚úÖ vscode-php-debug adapter instalado correctamente")
        (error "‚ùå Error instalando el adaptador")))
    (file-exists-p adapter-file)))

;; Comando para reinstalar si hace falta
(defun dape-reinstall-php-debug-adapter ()
  "Reinstala vscode-php-debug adapter forzosamente."
  (interactive)
  (let ((adapter-dir (expand-file-name "~/.config/doom/debug-adapters/php-debug")))
    (when (file-exists-p adapter-dir)
      (delete-directory adapter-dir t)
      (message "üóëÔ∏è  Adaptador anterior eliminado"))
    (dape-ensure-php-debug-adapter)))
#+end_src

*** Paso 2: Configurar dape con instalaci√≥n autom√°tica

#+begin_src elisp
(use-package! dape
  :config
  ;; PHP con Xdebug 3.x - El adaptador se instala autom√°ticamente
  (add-to-list 'dape-configs
               `(phpListen
                 modes (php-mode)
                 ensure dape-ensure-php-debug-adapter  ;; ‚Üê Instalaci√≥n autom√°tica
                 command "node"
                 command-args (,(expand-file-name "~/.config/doom/debug-adapters/php-debug/extension/out/phpDebug.js"))
                 :type "php"
                 :request "launch"
                 :mode "listen"
                 :port 9003)))
#+end_src

*IMPORTANTE*: El adaptador se descarga e instala autom√°ticamente la primera vez que ejecutas =M-x dape=.

*** Paso 3: Configurar Xdebug

En tu =php.ini=:

#+begin_src ini
zend_extension=xdebug.so
xdebug.mode=debug
xdebug.start_with_request=yes
xdebug.client_host=127.0.0.1
xdebug.client_port=9003
#+end_src

* Uso B√°sico de Dape

** Workflow t√≠pico

1. *Abrir archivo* PHP en Emacs
2. *Poner breakpoint*: =M-x dape-breakpoint-toggle= (o =SPC m d b= en Doom)
3. *Iniciar dape*: =M-x dape= ‚Üí seleccionar =phpListen=
4. *Hacer request* a tu app PHP (curl, browser, etc)
5. Emacs se *pausar√° en el breakpoint*

** Comandos en el REPL de dape

Una vez pausado en un breakpoint:

| Comando    | Acci√≥n                               |
|------------+--------------------------------------|
| =next=     | Ejecutar siguiente l√≠nea (step over) |
| =step=     | Entrar en funci√≥n (step into)        |
| =out=      | Salir de funci√≥n (step out)          |
| =continue= | Continuar ejecuci√≥n                  |
| =pause=    | Pausar ejecuci√≥n                     |
| =restart=  | Reiniciar sesi√≥n de debug            |
| =quit=     | Terminar debug                       |

** Inspeccionar variables

En el REPL, puedes escribir:
- Nombre de variable: =$myVar=
- Expresiones: =$user->getName()=

* Configuraciones para Otros Lenguajes

** JavaScript/Node.js

#+begin_src elisp
(js-debug
  modes (js-mode typescript-mode)
  command "node"
  command-args ("~/.config/doom/debug-adapters/js-debug/dapDebugServer.js")
  port 8123
  :type "node"
  :request "launch"
  :program "${file}")
#+end_src

** Python

#+begin_src elisp
(debugpy
  modes (python-mode)
  command "python"
  command-args ("-m" "debugpy.adapter")
  port 5678
  :type "python"
  :request "launch"
  :program "${file}")
#+end_src

** Go (delve)

#+begin_src elisp
(dlv
  modes (go-mode)
  ensure dape-ensure-command
  command "dlv"
  command-args ("dap" "--listen" "127.0.0.1::autoport")
  :type "go"
  :request "launch"
  :program ".")
#+end_src

* Keybindings Recomendados

En =config.el=:

#+begin_src elisp
(map! :map php-mode-map
      :localleader
      (:prefix ("d" . "debug")
       "d" #'dape
       "b" #'dape-breakpoint-toggle
       "n" #'dape-next
       "s" #'dape-step-in
       "o" #'dape-step-out
       "c" #'dape-continue
       "q" #'dape-quit
       "r" #'dape-restart))
#+end_src

Entonces en un archivo PHP:
- =SPC m d d= ‚Üí Iniciar dape
- =SPC m d b= ‚Üí Toggle breakpoint
- =SPC m d n= ‚Üí Next (step over)
- etc.

* Instalaci√≥n Autom√°tica de Adaptadores (RECOMENDADO)

** ¬øPor qu√© automatizar?

La instalaci√≥n manual de adaptadores es tediosa y propensa a errores. Con la funci√≥n autom√°tica:

- ‚úÖ Se descarga e instala autom√°ticamente al usar dape por primera vez
- ‚úÖ Verifica que el adaptador existe antes de usarlo
- ‚úÖ F√°cil reinstalaci√≥n si algo falla
- ‚úÖ Cero configuraci√≥n manual

** C√≥mo funciona

La funci√≥n =dape-ensure-php-debug-adapter= se ejecuta cuando:
1. Intentas iniciar dape (=M-x dape=)
2. El par√°metro =ensure= en la config llama a la funci√≥n
3. La funci√≥n verifica si existe el adaptador
4. Si no existe, lo descarga e instala autom√°ticamente

** Comandos √∫tiles

- =M-x dape-reinstall-php-debug-adapter= - Reinstalar adaptador forzosamente
- √ötil si la instalaci√≥n fall√≥ o hay una nueva versi√≥n

** Estructura de directorios

Despu√©s de la instalaci√≥n autom√°tica:

#+begin_src
~/.config/doom/debug-adapters/
‚îî‚îÄ‚îÄ php-debug/
    ‚îú‚îÄ‚îÄ extension/
    ‚îÇ   ‚îî‚îÄ‚îÄ out/
    ‚îÇ       ‚îî‚îÄ‚îÄ phpDebug.js  ‚Üê El adaptador
    ‚îî‚îÄ‚îÄ ...
#+end_src

* Troubleshooting

** "Adapter connection shutdown"

Posibles causas:
1. El adaptador no est√° instalado correctamente
2. Node.js no est√° disponible
3. Ruta incorrecta al adaptador
4. El adaptador usa TCP en lugar de stdio

Soluci√≥n:
#+begin_src bash
# Verificar que node existe
which node

# Verificar que el adaptador existe
ls ~/.config/doom/debug-adapters/php-debug/extension/out/phpDebug.js

# Si no existe, reinstalar:
# M-x dape-reinstall-php-debug-adapter

# Verificar que Xdebug est√° cargado
php -v | grep -i xdebug
#+end_src

*IMPORTANTE*: Aseg√∫rate de que la configuraci√≥n NO use =--server=9003= en =command-args=. El adaptador debe usar *stdio*, no modo servidor TCP.

** Xdebug no se conecta

#+begin_src bash
# Ver logs de Xdebug
tail -f /tmp/xdebug.log

# Verificar que el puerto est√° abierto
netstat -tuln | grep 9003
#+end_src

** Breakpoints no funcionan

1. Aseg√∫rate de que =xdebug.start_with_request=yes= en php.ini
2. Verifica que el puerto coincide (9003)
3. Comprueba path mappings si usas Docker

* Recursos

- [[https://github.com/svaante/dape][Dape en GitHub]]
- [[https://microsoft.github.io/debug-adapter-protocol/][Debug Adapter Protocol Spec]]
- [[https://xdebug.org/docs/][Xdebug Documentation]]
- [[https://github.com/xdebug/vscode-php-debug][vscode-php-debug (el adaptador)]]

* Ventajas de Dape sobre Depuraci√≥n Tradicional

** Sin dape (print debugging)

#+begin_src php
<?php
echo "DEBUG: user = ";
var_dump($user);  // ‚Üê Esto
die();            // ‚Üê Y esto
#+end_src

Problemas:
- Ensuciar c√≥digo con prints
- Reiniciar servidor cada vez
- Ver solo lo que imprimiste
- Olvidar quitar los prints

** Con dape

- Breakpoints temporales (no tocar c√≥digo)
- Inspeccionar *todas* las variables
- Step through c√≥digo l√≠nea por l√≠nea
- Ver call stack completo
- Evaluar expresiones on-the-fly

* Filosof√≠a de Dape

Dape sigue la filosof√≠a Unix:

#+begin_quote
"Do one thing and do it well"
#+end_quote

- *Minimalista*: Solo lo esencial para debugging
- *Expl√≠cito*: T√∫ controlas todo, nada m√°gico
- *Composable*: Se integra bien con otras herramientas de Emacs
- *Extensible*: F√°cil a√±adir nuevos lenguajes

No intenta ser un IDE completo, solo un excelente debugger.
